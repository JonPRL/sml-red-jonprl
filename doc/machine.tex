\documentclass{article}
\usepackage{libertine}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{perfectcut}
\usepackage{fullpage}
\usepackage{manfnt}
\usepackage{resizegather}

% for dumb blackboard greek
\usepackage{breqn}
\usepackage[bbgreekl]{mathbbol}
\usepackage{bbm}

\global\long\def\cut#1#2{\perfectcut{#1}{#2}}

\newcommand\DimEq[3]{{#1}\vDash{#2}={#3}}
\newcommand\DimApart[3]{{#1}\vDash{#2}\mathrel{\#}{#3}}
\newcommand\Clo[2]{#1\triangleleft{#2}}
\newcommand\Coe[4]{\mathsf{coe}^{#1\leadsto{#2}}_{#3} (#4)}
\newcommand\Com[5]{\mathsf{com}^{#1\leadsto{#2}}_{#3} (#4;#5)}
\newcommand\HCom[5]{\mathsf{hcom}^{#1\leadsto{#2}}_{#3} (#4;#5)}
\newcommand\FCom[4]{\mathsf{fcom}^{#1\leadsto{#2}} (#3;#4)}
\newcommand\DFun[3]{\perfectparens{#1:#2}\to{#3}}
\newcommand\DPair[3]{\perfectparens{#1:#2}\times{#3}}
\newcommand\PAbs[2]{\perfectunary{CurrentHeight}{\langle}{\rangle}{#1}{#2}}
\newcommand\PApp[2]{#1\mathbin{@}#2}
\newcommand\Path[3]{\mathsf{path}_{#1} (#2;#3)}
\newcommand\Lam[2]{\lambda{#1}.{#2}}
\newcommand\Fst[1]{\mathsf{fst} (#1)}
\newcommand\Snd[1]{\mathsf{snd} (#1)}
\newcommand\Loop[1]{\mathsf{loop}_{#1}}
\newcommand\Circ{\mathbb{S}^1}
\newcommand\CircRec[4]{\Circ\mathsf{rec}_{#1} (#2;#3;#4)}
\newcommand\Base{\mathsf{base}}

\newcommand\Cons[2]{{#1}\dblcolon{#2}}
\newcommand\FreeVars[1]{\mathbf{FV}\perfectparens{#1}}
\newcommand\FreeDims[1]{\mathbf{FD}\perfectparens{#1}}
\newcommand\Bool{\mathsf{bool}}
\newcommand\WBool{\mathsf{wbool}}
\newcommand\Frame[3]{\perfectparens{#1,#2,#3}}
\newcommand\Cfg[3]{\cut{\Clo{#1}{#2}}{#3}}
\newcommand\App[2]{{#1}\perfectparens{#2}}
\newcommand\Pair[2]{\perfectunary{CurrentHeight}{\langle}{\rangle}{#1,#2}}

\newcommand\Stable{\text{\mancube}}
\newcommand\NonStable{\bullet}
\newcommand\Step[3]{{#2}\mathrel{\succ_{#1}}{#3}}
\newcommand\AStep[3]{{#2}&\mathrel{\succ_{#1}}{#3}}
\newcommand\AStepSt[2]{\AStep{\Stable}{#1}{#2}}
\newcommand\Meta[1]{\mathbb{#1}}

\title{Cubical Abstract Machine}
\author{Jon Sterling and Kuen-Bang Hou (Favonia)}

\begin{document}
\maketitle

\[
  \begin{array}{rrlr}
    M,A &::= &a\mid \Meta{x}[\vec{r};\vec{M}] \mid \Bool \mid \WBool \mid \Circ \mid \Pair{M}{N}\mid\Fst{M}\mid\Snd{M}\mid\Lam{x}{M}\mid\App{M}{N}\mid\PAbs{x}{M}\mid\PApp{M}{r}
    \\
    &&\Coe{r}{r'}{x.A}{M}\mid\HCom{r}{r'}{A}{M}{\overline{\xi\hookrightarrow{}y.N}}\mid\FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}\\
    &&\Com{r}{r'}{x.A}{M}{\overline{\xi\hookrightarrow{}y.N}}\mid\ldots&\text{(terms)}\\
    K &::= &\Coe{r}{r'}{\Box}{M}\mid\App{\Box}{N}\mid\Fst{\Box}\mid\Snd{\Box}\mid\PApp{\Box}{r}\mid\HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}\mid\ldots&\text{(continuations)}\\
    C &::= &\Clo{M}{\mathcal{E}}&\text{(closures)}\\
    \mathcal{E} &::= &(\Meta{\gamma},\gamma,\psi)&\text{(environments)}\\
    \Meta{\gamma} &::= &\overline{\Meta{x}\hookrightarrow \vec{x};\vec{a}.\Clo{M}{\mathcal{E}}}&\text{(meta env.)}\\
    \gamma &::= &\overline{a\hookrightarrow C}&\text{(object env.)}\\
    \psi &::= &\overline{x\hookrightarrow r}&\text{(dimension env.)}\\
    f &::= &\Frame{K}{\mathcal{E}}{\Psi} &\text{(frames)}\\
    \pi &::= &\cdot \mid \Cons{f}{\pi} &\text{(stacks)}\\
    \mathcal{C} &::= &\Cfg{M}{\mathcal{E}}{\pi} &\text{(states)}
  \end{array}
\]

This machine is similar to both Krivine's environment machine and the
CEK machine. To be honest, Jon Sterling is not really sure of what
delineates these from each other, except that they usually seem to be
call-by-name and call-by-value respectively. Ours is call-by-name.

\paragraph{Stack frames and machine states}

A stack frame $\Frame{K}{\mathcal{E}}{\Psi}$ represents a continuation
whose hole ranges over a binder of $\Psi$ dimensions. For a stack
$\pi$, let $\vec{\Psi}$ be the aggregation of all the dimension
bindings $\Psi$ mentioned in $\pi$; then the extension of a stack
$\Cons{\Frame{K}{\mathcal{E}}{\Phi}}{\pi}$ is wellformed when
$\mathcal{E}$ is an environment for $\FreeDims{K}\setminus\vec{\Psi}$;
moreover, $K$ is allowed to mention the dimensions in $\vec{\Psi}$.

A machine state $\Cfg{M}{\mathcal{E}}{\pi}$, where $\vec{\Psi}$ is the
aggregation of dimension bindings in $\pi$, is wellformed when
$\mathcal{E}$ is an environment for $\FreeDims{M}\setminus\vec{\Psi}$;
moreover, $M$ is allowed to mention the dimensions in $\vec{\Psi}$.

\paragraph{Selected transition rules}

We define a transition judgment
$\Step{\mu}{\mathcal{C}}{\mathcal{C}'}$ with $\mu$ ranging over
the following possible modes:
\begin{enumerate}
\item $\Stable$, denoting a cubically stable transition
\item $\NonStable$, denoting a non-cubically stable transition
\end{enumerate}

Moreover, if $\Step{\Stable}{\mathcal{C}}{\mathcal{C}'}$ then
$\Step{\NonStable}{\mathcal{C}}{\mathcal{C}'}$.


\begin{mathparpagebreakable}
  \inferrule{
    \mathcal{E} (a)\equiv\Clo{M}{\mathcal{E}'}
  }{
    \Step{\Stable}{
      \Cfg{a}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E} (\Meta{x})\equiv{\vec{x};\vec{a}.\Clo{N}{\mathcal{E}'}}
    \and
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',
      \overline{a\hookrightarrow\Clo{M}{\mathcal{E}}},
      \overline{x\hookrightarrow\mathcal{E} (r)}
    }
  }{
    \Step{\Stable}{
      \Cfg{\Meta{x}[\vec{r};\vec{M}]}{\mathcal{E}}{\pi}
    }{
      \Cfg{N}{\mathcal{E}''}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\App{M}{N}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Lam{a}{M}}{\mathcal{E}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}'}{[]}}{\pi}}
    }{
      \Cfg{M}{[\mathcal{E},a\hookrightarrow{\Clo{N}{\mathcal{E}}}]}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Fst{M}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\Fst{\Box}}{\mathcal{E}}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Snd{M}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\Snd{\Box}}{\mathcal{E}}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Pair{M}{N}}{\mathcal{E}}{\Cons{\Frame{\Fst{\Box}}{\mathcal{E}'}{[]}}{\pi}}
    }{
      \Cfg{M}{\mathcal{E}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Pair{M}{N}}{\mathcal{E}}{\Cons{\Frame{\Snd{\Box}}{\mathcal{E}'}{[]}}{\pi}}
    }{
      \Cfg{N}{\mathcal{E}}{\pi}
    }
  }
  \and
  \inferrule{
    \DimEq{\mathcal{E}}{r}{\epsilon}
  }{
    \Step{\Stable}{
      \Cfg{\Loop{r}}{\mathcal{E}}{\pi}
    }{
      \Cfg{\Base}{\mathcal{E}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{
        \CircRec{a.A}{M}{P}{x.L}
      }{
        \mathcal{E}
      }{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Base}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{P}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
    \DimEq{\mathcal{E}}{r}{w}
  }{
    \Step{\NonStable}{
      \Cfg{\Loop{r}}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{L}{
        \perfectbrackets{
          \mathcal{E}',x\hookrightarrow{w}
        }
      }{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\PApp{M}{r}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{
          \Frame{\PApp{\Box}{r}}{\mathcal{E}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\PAbs{x}{M}}{\mathcal{E}}{
        \Cons{
          \Frame{\PApp{\Box}{r}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{M}{
        \perfectbrackets{
          \mathcal{E},x\hookrightarrow\mathcal{E}' (r)
        }
      }{\pi}
    }
  }
\end{mathparpagebreakable}

The rules for coercions are more difficult, but using second-order
substitutions we can account for them without needing to force
closures.

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Coe{r}{r'}{x.A}{M}}{\mathcal{E}}{\pi}
    }{
      \Cfg{A}{\mathcal{E}}{
        \Cons{
          \Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Bool}{\mathcal{E}}{
        \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}'' \triangleq%
    \perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow%
      x;b.\Clo{B}{
        \perfectbrackets{
          \mathcal{E},a\hookrightarrow%
          \Clo{
            \Coe{r'}{x}{x.\Meta{z}[x]}{b}
          }{
            \perfectbrackets{
              \mathcal{E'},
              \Meta{z}\hookrightarrow%
              x.\Clo{A}{\mathcal{E}}
            }
          }
        }
      },
      \Meta{y}\hookrightarrow%
      x.\Clo{A}{\mathcal{E}}
    }
  }{
    \Step{\Stable}{
      \Cfg{\DFun{a}{A}{B}}{\mathcal{E}}{\Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}}
    }{
      \Cfg{
        \Lam{a}{
          \Coe{r}{r'}{x.\Meta{x}[x;a]}{
            \App{M}{
              \Coe{r'}{r}{x.\Meta{y}[x]}{a}
            }
          }
        }
      }{
        \mathcal{E}''
      }{
        \pi%
      }
    }
  }
  \and
  \inferrule{
    \mathcal{E}'' \triangleq%
    \perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{x.\Clo{A}{\mathcal{E}}},
      \Meta{y}\hookrightarrow{x.\Clo{B}{[\mathcal{E},a\hookrightarrow\Clo{\Coe{r}{x}{y.\Meta{x}[y]}{\Snd{M}}}{[\mathcal{E},\Meta{x}\hookrightarrow{x.\Clo{A}{\mathcal{E}}}]}]}}
    }
  }{
    \Step{\Stable}{
      \Cfg{
        \DPair{a}{A}{B}
      }{
        \mathcal{E}
      }{
        \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
      }
    }{
      \Cfg{
        \Pair{
          \Coe{r}{r'}{x.\Meta{x}[x]}{\Fst{M}}
        }{
          \Coe{r}{r'}{x.\Meta{y}[x]}{\Snd{M}}
        }
      }{
        \mathcal{E}''
      }{
        \pi%
      }
    }
  }
  \and
  \inferrule{
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{}x.\Clo{A}{\mathcal{E}},
      \overline{
        \Meta{y}_\epsilon\hookrightarrow{}.\Clo{P_\epsilon}{\mathcal{E}}
      }
    }
  }{
    \Step{\Stable}{
      \Cfg{
        \Path{x.A}{P_0}{P_1}
      }{
        \mathcal{E}
      }{
        \Cons{
          \Frame{
            \Coe{r}{r'}{\Box}{M}
          }{\mathcal{E}'}{[x]}
        }{\pi}
      }
    }{
      \Cfg{
        \PAbs{x}{
          \Com{r}{r'}{y.\Meta{x}[y]}{\PApp{M}{x}}{
            \overline{
              x=\epsilon\hookrightarrow{}y.{\Meta{y}_\epsilon}
            }
          }
        }
      }{\mathcal{E}''}{\pi}
    }
  }
\end{mathparpagebreakable}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{
        \HCom{r}{r'}{A}{M}{\overline{\xi\hookrightarrow{}y.N}}
      }{\mathcal{E}}{\pi}
    }{
      \Cfg{A}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{
        \Com{r}{r'}{x.A}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
      }{\mathcal{E}}{\pi}
    }{
      \Cfg{
        \HCom{r}{r'}{A}{
          \Coe{r}{r'}{y.A}{M}
        }{
          \overline{
            \xi_i\hookrightarrow{}y.\Coe{y}{r'}{y.A}{N_i}
          }
        }
      }{
        \perfectbrackets{
          \mathcal{E},
          y\hookrightarrow{r'}
        }
      }{\pi}
    }
  }
  \and
  \inferrule{
    \DimEq{\mathcal{E}}{r}{r'}
  }{
    \Step{\Stable}{
      \Cfg{\FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\pi}
    }
  }
  \and
  \inferrule{
    \DimApart{\mathcal{E}}{r}{r'}
    \\
    \DimApart{\mathcal{E}}{r_i}{r'_i}\ (\forall{}i<j)
    \\
    \DimEq{\mathcal{E}}{r_j}{r'_j}
  }{
    \Step{\NonStable}{
      \Cfg{
        \FCom{r}{r'}{M}{
          \overline{
            r_i=r'_i\hookrightarrow{}y.N_i
          }
        }
      }{\mathcal{E}}{\pi}
    }{
      \Cfg{N_j}{
        \perfectbrackets{
          \mathcal{E},y\hookrightarrow{}\mathcal{E} (r')
        }
      }{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\Bool}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\Stable}{
      \Cfg{\WBool}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}
      }{\mathcal{E'}}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',\Meta{x}\hookrightarrow{}a.\Clo{B}{\mathcal{E}}
    }
  }{
    \Step{\Stable}{
      \Cfg{
        \DFun{x}{A}{B}
      }{
        \mathcal{E}
      }{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \Lam{a}{
          \HCom{r}{r'}{\Meta{x}[a]}{\App{M}{a}}{
            \overline{\xi_i\hookrightarrow{}y.\App{N_i}{a}}
          }
        }
      }{\mathcal{E}''}{\pi}
    }
  }
  \and
  \inferrule{
    L_s\triangleq{
      \HCom{r}{s}{\Meta{x}}{\Fst{M}}{\overline{\xi_i\hookrightarrow{}y.\Fst{N_i}}}
    }
    \\
    R\triangleq{
      \Com{r}{r'}{z.\Meta{y}[z]}{\Snd{M}}{
        \overline{\xi_i\hookrightarrow{}y.\Snd{N_i}}
      }
    }
    \\\\
    \mathcal{E}''\triangleq{
      \perfectbrackets{
        \mathcal{E}',
        \Meta{x}\hookrightarrow{}.\Clo{A}{\mathcal{E}}
      }
    }
    \\
    \mathcal{E}'''\triangleq{
      \perfectbrackets{
        \mathcal{E}'',
        \Meta{y}\hookrightarrow{}z.\Clo{
          B
        }{
          \perfectbrackets{
            \mathcal{E},
            a\hookrightarrow{}
            \Clo{L_z}{\mathcal{E}''}
          }
        }
      }
    }
  }{
    \Step{\Stable}{
      \Cfg{\DPair{a}{A}{B}}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \Pair{L_{r'}}{R}
      }{
        \mathcal{E}'''
      }{\pi}
    }
  }
  \and
  \inferrule{
    H\triangleq{
      \HCom{r}{r'}{\Meta{x}[x]}{\PApp{M}{x}}{
        \overline{
          x=\epsilon\hookrightarrow{}y.\Meta{y}_\epsilon%
        },
        \overline{
          \xi_i\hookrightarrow{}y.\PApp{N_i}{x}
        }
      }
    }
    \\
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{}x.\Clo{A}{\mathcal{E}},
      \overline{
        \Meta{y}_\epsilon\hookrightarrow{}.\Clo{P_\epsilon}{\mathcal{E}}%
      }
    }
  }{
    \Step{\Stable}{
      \Cfg{\Path{x.A}{P_0}{P_1}}{
        \mathcal{E}
      }{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{
              \overline{
                \xi_i\hookrightarrow{}y.N_i
              }
            }
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \PAbs{x}{H}
      }{\mathcal{E}''}{\pi}
    }
  }
\end{mathparpagebreakable}


\paragraph{Unloading the machine}

We can unload the machine at any time; this is useful if we are
computing an open term and hit a variable.

\begin{mathpar}
  \inferrule{
  }{
    \Cfg{M}{\mathcal{E}}{\cdot}\Longrightarrow{M[\mathcal{E}]}
  }
  \and
  \inferrule{
    \Cfg{K[\Psi.M[\mathcal{E}]]}{\mathcal{E}'}{\pi}\Longrightarrow{N}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{K[\Box]}{\mathcal{E}'}{\Psi}}{\pi}}\Longrightarrow{N}
  }
\end{mathpar}

But using Favonia's Thought, we can come up with something more
efficient. This na\"ive version is rather appalling.


\end{document}
