\documentclass{article}
\usepackage{libertine}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{perfectcut}
\usepackage{fullpage}

\global\long\def\cut#1#2{\perfectcut{#1}{#2}}

\newcommand\Clo[2]{#1\triangleleft{#2}}
\newcommand\Coe[4]{\mathsf{coe}^{#1\leadsto{#2}}_{#3} (#4)}
\newcommand\DFun[3]{\perfectparens{#1:#2}\to{#3}}
\newcommand\DPair[3]{\perfectparens{#1:#2}\times{#3}}
\newcommand\Lam[2]{\lambda{#1}.{#2}}
\newcommand\Fst[1]{\mathsf{fst} (#1)}
\newcommand\Snd[1]{\mathsf{snd} (#1)}
\newcommand\Loop[1]{\mathsf{loop}_{#1}}
\newcommand\Base{\mathsf{base}}

\newcommand\Cons[2]{{#1}\dblcolon{#2}}
\newcommand\AStep[2]{{#1}&\succ{#2}}
\newcommand\FreeVars[1]{\mathbf{FV}\perfectparens{#1}}
\newcommand\FreeDims[1]{\mathbf{FD}\perfectparens{#1}}
\newcommand\Bool{\mathsf{bool}}
\newcommand\Frame[3]{\perfectparens{#1,#2,#3}}
\newcommand\Cfg[3]{\cut{\Clo{#1}{#2}}{#3}}
\newcommand\App[2]{{#1}\perfectparens{#2}}
\newcommand\Pair[2]{\perfectunary{CurrentHeight}{\langle}{\rangle}{#1,#2}}


\title{Cubical Abstract Machine}

\begin{document}
\maketitle

\[
  \begin{array}{rrlr}
    M,A &::= &a\mid \Coe{r}{r'}{x.A}{M}\mid\ldots&\text{(terms)}\\
    K &::= &\Coe{r}{r'}{\Box}{M}\mid\ldots&\text{(continuations)}\\
    C &::= &\Clo{M}{\mathcal{E}}&\text{(closures)}\\
    \mathcal{E} &::= &(\gamma,\psi)&\text{(environments)}\\
    \gamma &::= &\overline{a\hookrightarrow C}&\text{(object env.)}\\
    \psi &::= &\overline{x\hookrightarrow r}&\text{(dimension env.)}\\
    f &::= &\Frame{K}{\mathcal{E}}{\Psi} &\text{(frames)}\\
    \pi &::= &\cdot \mid \Cons{f}{\pi} &\text{(stacks)}\\
    \mathcal{C} &::= &\Cfg{M}{\mathcal{E}}{\pi} &\text{(states)}
  \end{array}
\]

We will write $M[\mathcal{E}]$ for substituting the free dimensions
and variables of a term $M$ using an environment $\mathcal{E}$.

\paragraph{Stack frames and machine states}

A stack frame $\Frame{K}{\mathcal{E}}{\Psi}$ represents a continuation
whose whole binds $\Psi$ dimensions. For a stack $\pi$, let
$\vec{\Psi}$ be the aggregation of all the dimension bindings $\Psi$
mentioned in $\pi$; then the extension of a stack
$\Cons{\Frame{K}{\mathcal{E}}{\Phi}}{\pi}$ is wellformed when
$\mathcal{E}$ is an environment for $\FreeDims{K}\setminus\vec{\Psi}$;
moreover, $K$ is allowed to mention the dimensions in $\vec{\Psi}$.

A machine state $\Cfg{M}{\mathcal{E}}{\pi}$, where $\vec{\Psi}$ is the
aggregation of dimension bindings in $\pi$, is wellformed when
$\mathcal{E}$ is an environment for $\FreeDims{M}\setminus\vec{\Psi}$;
moreover, $M$ is allowed to mention the dimensions in $\vec{\Psi}$.

\paragraph{Selected transition rules}
\begin{align}
  \AStep{
    \Cfg{a}{(\gamma,\psi)}{\pi}
  }{
    \Cfg{\gamma(a)}{(\gamma,\psi)}{\pi}
  }
  \\
  \AStep{
    \Cfg{\App{M}{N}}{\mathcal{E}}{\pi}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}}{[]}}{\pi}}
  }
  \\
  \AStep{
    \Cfg{\Lam{a}{M}}{\mathcal{E}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}'}{[]}}{\pi}}
  }{
    \Cfg{M}{[\mathcal{E},a\hookrightarrow{\Clo{N}{\mathcal{E}}}]}{\pi}
  }
  \\
  \AStep{
    \Cfg{\Fst{M}}{\mathcal{E}}{\pi}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\Fst{\Box}}{\mathcal{E}}{[]}}{\pi}}
  }
  \\
  \AStep{
    \Cfg{\Snd{M}}{\mathcal{E}}{\pi}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{\Snd{\Box}}{\mathcal{E}}{[]}}{\pi}}
  }
  \\
  \AStep{
    \Cfg{\Pair{M}{N}}{\mathcal{E}}{\Cons{\Frame{\Fst{\Box}}{\mathcal{E}'}{[]}}{\pi}}
  }{
    \Cfg{M}{\mathcal{E}}{\pi}
  }
  \\
  \AStep{
    \Cfg{\Pair{M}{N}}{\mathcal{E}}{\Cons{\Frame{\Snd{\Box}}{\mathcal{E}'}{[]}}{\pi}}
  }{
    \Cfg{N}{\mathcal{E}}{\pi}
  }
  \\
  \AStep{
    \Cfg{\Loop{r}}{(\gamma,\psi)}{\pi}
  }{
    \Cfg{\Base}{(\gamma,\psi)}{\pi}
  }
  \textbf{ when } r\psi = \epsilon
  \\
  \AStep{
    \Cfg{\Coe{r}{r'}{x.A}{M}}{\mathcal{E}}{\pi}
  }{
    \Cfg{A}{\mathcal{E}}{
      \Cons{
        \Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}
      }{\pi}
    }
  }
  \\
  \AStep{
    \Cfg{\Bool}{\mathcal{E}}{
      \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
    }
  }{
    \Cfg{M}{\mathcal{E}'}{\pi}
  }
  \\
  \AStep{
    \Cfg{
      \DFun{a}{A}{B}
    }{
      \mathcal{E}
    }{
      \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
    }
  }{
    \Cfg{
      \Lam{b}{
        \Coe{r}{r'}{
          x.B[\mathcal{E},a\hookrightarrow \Clo{\Coe{r'}{x}{x.A}{b}}{\mathcal{E}}]
        }{
          \App{M}{
            \Coe{r'}{r}{x. A[\mathcal{E}]}{b}
          }
        }
      }
    }{
      \mathcal{E}'
    }{
      \pi
    }
  }
\end{align}

The dynamics of coercion on a functional type are unfortunate: it is
necessary to force the substitution $\mathcal{E}$ on the types $A$ and
$B$, since we are ``suspending'' the coercion and placing it
underneath a $\lambda$-abstraction. The same problem occurs for pair
types. This suggests that we may ultimately need some kind of explicit
substitution in our calculus.

\begin{align}
  \AStep{
    \Cfg{
      \DPair{a}{A}{B}
    }{
      \mathcal{E}
    }{
      \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
    }
  }{
    \Cfg{
      \Pair{
        \Coe{r}{r'}{x.A[\mathcal{E}]}{\Fst{M}}
      }{
        \Coe{r}{r'}{
          x.B[\mathcal{E},a\hookrightarrow\Clo{\Coe{r}{x}{x.A[\mathcal{E}]}{\Fst{M}}}{\mathcal{E}'}]
        }{
          \Snd{M}
        }
      }
    }{
      \mathcal{E}'
    }{
      \pi
    }
  }
\end{align}

\paragraph{Unloading the machine}

We can unload the machine at any time; this is useful if we are
computing an open term and hit a variable.

\begin{mathpar}
  \inferrule{
  }{
    \Cfg{M}{\mathcal{E}}{\cdot}\Longrightarrow{M[\mathcal{E}]}
  }
  \and
  \inferrule{
    \Cfg{K[\Psi.M[\mathcal{E}]]}{\mathcal{E}'}{\pi}\Longrightarrow{N}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{K[\Box]}{\mathcal{E}'}{\Psi}}{\pi}}\Longrightarrow{N}
  }
\end{mathpar}


\end{document}
