\documentclass{article}
\usepackage{libertine}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{wasysym}
\usepackage{perfectcut}
\usepackage{fullpage}
\usepackage{manfnt}
\usepackage{resizegather}

% for dumb blackboard greek
\usepackage{breqn}
\usepackage[bbgreekl]{mathbbol}
\usepackage{bbm}

\global\long\def\cut#1#2{\perfectcut{#1}{#2}}

\newcommand\StackBindings[1]{\mathbf{bindings} (#1)}
\newcommand\DimEq[3]{{#1}\vDash{#2}={#3}}
\newcommand\DimApart[5]{{#1}\vDash_{#2}{#4}\not={#5}\parallel{#3}}
\newcommand\Env[2]{#1\star{#2}}
\newcommand\Clo[3]{#1\triangleleft{\Env{#2}{#3}}}
\newcommand\Coe[4]{\mathsf{coe}^{#1\leadsto{#2}}_{#3} (#4)}
\newcommand\Com[5]{\mathsf{com}^{#1\leadsto{#2}}_{#3} (#4;#5)}
\newcommand\HCom[5]{\mathsf{hcom}^{#1\leadsto{#2}}_{#3} (#4;#5)}
\newcommand\FCom[4]{\mathsf{fcom}^{#1\leadsto{#2}} (#3;#4)}
\newcommand\DFun[3]{\perfectparens{#1:#2}\to{#3}}
\newcommand\DPair[3]{\perfectparens{#1:#2}\times{#3}}
\newcommand\PAbs[2]{\perfectunary{CurrentHeight}{\langle}{\rangle}{#1}{#2}}
\newcommand\PApp[2]{#1\mathbin{@}#2}
\newcommand\Path[3]{\mathsf{path}_{#1} (#2;#3)}
\newcommand\Lam[2]{\lambda{#1}.{#2}}
\newcommand\Fst[1]{\mathsf{fst} (#1)}
\newcommand\Snd[1]{\mathsf{snd} (#1)}
\newcommand\Loop[1]{\mathsf{loop}_{#1}}
\newcommand\Circ{\mathbb{S}^1}
\newcommand\CircRec[4]{\Circ\mathsf{rec}_{#1} (#2;#3;#4)}
\newcommand\Base{\mathsf{base}}
\newcommand\True{\mathsf{true}}
\newcommand\False{\mathsf{false}}
\newcommand\If[3]{\mathsf{if} (#1; #2; #3)}
\newcommand\WIf[4]{\mathsf{if}_{#1} (#2; #3; #4)}

\newcommand\Cons[2]{{#1}\dblcolon{#2}}
\newcommand\FreeVars[1]{\mathbf{FV}\perfectparens{#1}}
\newcommand\FreeDims[1]{\mathbf{FD}\perfectparens{#1}}
\newcommand\Bool{\mathsf{bool}}
\newcommand\WBool{\mathsf{wbool}}
\newcommand\Frame[4]{\perfectparens{#1,\Env{#2}{#3},#4}}
\newcommand\Cfg[4]{\cut{\Clo{#1}{#2}{#3}}{#4}}
\newcommand\App[2]{{#1}\perfectparens{#2}}
\newcommand\Pair[2]{\perfectunary{CurrentHeight}{\langle}{\rangle}{#1,#2}}

\newcommand\Stable{\text{\mancube}}
\newcommand\NonStable{\bullet}
\newcommand\Step[3]{{#2}\mathrel{\succ_{#1}}{#3}}
\newcommand\AStep[3]{{#2}&\mathrel{\succ_{#1}}{#3}}
\newcommand\AStepSt[2]{\AStep{\Stable}{#1}{#2}}
\newcommand\Meta[1]{\mathbb{#1}}

\title{Cubical Abstract Machine}
\author{Jon Sterling and Kuen-Bang Hou (Favonia)}

\begin{document}
\maketitle

\section{Machine structure}

\[
  \begin{array}{rrlr}
    M,A &::= &a\mid \Meta{x}[\vec{r};\vec{M}] \mid \Bool \mid \WBool \mid \Circ \mid \Pair{M}{N}\mid\Fst{M}\mid\Snd{M}\mid\Lam{x}{M}\mid\App{M}{N}\mid\PAbs{x}{M}\mid\PApp{M}{r}\\
    &&\If{M}{N}{N'}\mid\WIf{x.A}{M}{N}{N'}
    \\
    &&\Coe{r}{r'}{x.A}{M}\mid\HCom{r}{r'}{A}{M}{\overline{\xi\hookrightarrow{}y.N}}\mid\FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}\\
    &&\Com{r}{r'}{x.A}{M}{\overline{\xi\hookrightarrow{}y.N}}\mid\ldots&\text{(terms)}\\
    K &::= &\Coe{r}{r'}{\Box}{M}\mid\App{\Box}{N}\mid\Fst{\Box}\mid\Snd{\Box}\mid\PApp{\Box}{r}\mid\HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}\\
    &&\If{\Box}{M}{N}\mid\WIf{x.A}{\Box}{M}{N}\mid\ldots&\text{(continuations)}\\
    C &::= &\Clo{M}{\mathcal{E}}{\mathcal{F}}&\text{(closures)}\\
    \mathcal{E} &::= &(\Meta{\gamma},\gamma,\psi)&\text{(pre. env)}\\
    \mathcal{F} &::= &(\eta,\psi)&\text{(f.f.f.f.)}\\
    \Meta{\gamma} &::= &\overline{\Meta{x}\hookrightarrow \vec{x};\vec{a}.\Clo{M}{\mathcal{E}}{\mathcal{F}}}&\text{(meta env.)}\\
    \gamma &::= &\overline{a\hookrightarrow C}&\text{(object env.)}\\
    \eta &::= &\overline{a\hookrightarrow M}&\text{(forced obj. env.)}\\
    \psi &::= &\overline{x\hookrightarrow r}&\text{(dimension env.)}\\
    f &::= &\Frame{K}{\mathcal{E}}{\mathcal{F}}{\Psi} &\text{(frames)}\\
    \pi &::= &\cdot \mid \Cons{f}{\pi} &\text{(stacks)}\\
    \mathcal{C} &::= &\Cfg{M}{\mathcal{E}}{\mathcal{F}}{\pi} &\text{(states)}
  \end{array}
\]

This machine is similar to Krivine's environment machine; it also
bears a resembles to the CEK machine, with the difference that we use
an explicit stack rather than an inductive definition of
continuations.

\paragraph{Stack frames and machine states}

A stack frame $\Frame{K}{\mathcal{E}}{\mathcal{F}}{\Psi}$ represents a continuation
whose hole ranges over a binder of $\Psi$ dimensions. For a stack
$\pi$, let $\vec{\Psi}$ be the aggregation of all the dimension
bindings $\Psi$ mentioned in $\pi$; then the extension of a stack
$\Cons{\Frame{K}{\mathcal{E}}{\mathcal{F}}{\Phi}}{\pi}$ is wellformed when
$\Env{\mathcal{E}}{\mathcal{F}}$ is an environment for $\FreeDims{K}\setminus\vec{\Psi}$;
moreover, $K$ is allowed to mention the dimensions in $\vec{\Psi}$.

A machine state $\Cfg{M}{\mathcal{E}}{\mathcal{F}}{\pi}$, where $\vec{\Psi}$ is the
aggregation of dimension bindings in $\pi$, is wellformed when
$\Env{\mathcal{E}}{\mathcal{F}}$ is an environment for $\FreeDims{M}\setminus\vec{\Psi}$;
moreover, $M$ is allowed to mention the dimensions in $\vec{\Psi}$.

\section{Selected transition rules}

We define a transition judgment
$\Step{\mu}{\mathcal{C}}{\mathcal{C}'}$ with $\mu$ ranging over
the following possible modes:
\begin{enumerate}
\item $\Stable$, denoting a cubically stable transition
\item $\NonStable$, denoting a non-cubically stable transition
\end{enumerate}

Moreover, if $\Step{\Stable}{\mathcal{C}}{\mathcal{C}'}$ then
$\Step{\NonStable}{\mathcal{C}}{\mathcal{C}'}$.

\subsection{Dimensions}

First, let us collect all the bindings that are induced by the stack
frames:
\begin{align*}
  \StackBindings{\cdot} &= \varnothing\\
  \StackBindings{\Cons{\Frame{K}{\mathcal{E}}{\mathcal{F}}{\Psi}}{\pi}} &= \Psi\cup\StackBindings{\pi}
\end{align*}

Now, I think that it is cubically stable to observe apartness of
dimensions $r,r'$ in case either one of those dimensions is bound by
the stack.

\begin{mathparpagebreakable}
  \inferrule{
    \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r) = \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r')
  }{
    \DimEq{\Env{\mathcal{E}}{\mathcal{F}}}{r}{r'}
  }
  \and
  \inferrule{
    \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r) \not= \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r')
  }{
    \DimApart{\Env{\mathcal{E}}{\mathcal{F}}}{\NonStable}{\pi}{r}{r'}
  }
  \and
  \inferrule{
    \{\perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r),\perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r')\}\cap\StackBindings{\pi}\not=\varnothing{}
    \\
    \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r) \not= \perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r')
  }{
    \DimApart{\Env{\mathcal{E}}{\mathcal{F}}}{\Stable}{\pi}{r}{r'}
  }
\end{mathparpagebreakable}

\subsection{Variables}

\begin{mathparpagebreakable}
  \inferrule{
    \mathcal{E}^+ (a)\equiv\Clo{M}{\mathcal{E}'}{\mathcal{F}'}
  }{
    \Step{\mu}{
      \Cfg{a}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}'}{\perfectparens{\mathcal{F}\circ\mathcal{F}'}}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}^+ (\Meta{x})\equiv{\vec{x};\vec{a}.\Clo{N}{\mathcal{E}'}{\mathcal{F}'}}
    \and
    \mathcal{F}''\triangleq\perfectbrackets{
      \mathcal{F},
      \overline{a\hookrightarrow{M\perfectbrackets{\Env{\mathcal{E}}{\mathcal{F}}}}},
      \overline{x\hookrightarrow\perfectparens{\Env{\mathcal{E}}{\mathcal{F}}}^+ (r)}
    }
  }{
    \Step{\mu}{
      \Cfg{\Meta{x}[\vec{r};\vec{M}]}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{N}{\mathcal{E}'}{\perfectparens{\mathcal{F}''\circ\mathcal{F}'}}{\pi}
    }
  }
\end{mathparpagebreakable}

%NOTE, the above rule for metavariables is incorrect. One way to fix it
%is by forcing the substitutions in a certain order; maybe we can find
%another way to fix it.


\subsection{Kan operations}
\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{
        \HCom{r}{r'}{A}{M}{\overline{\xi\hookrightarrow{}y.N}}
      }{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{A}{\mathcal{E}}{\mathcal{F}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}}{\mathcal{F}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Coe{r}{r'}{x.A}{M}}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{A}{\mathcal{E}}{\mathcal{F}}{
        \Cons{
          \Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}}{\mathcal{F}}{[x]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{
        \Com{r}{r'}{x.A}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
      }{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{
        \HCom{r}{r'}{A}{
          \Coe{r}{r'}{y.A}{M}
        }{
          \overline{
            \xi_i\hookrightarrow{}y.\Coe{y}{r'}{y.A}{N_i}
          }
        }
      }{
        \perfectbrackets{
          \mathcal{E},
          x\hookrightarrow{\mathcal{E}^+(r')}
        }
      }{
        \mathcal{F}
      }{\pi}
    }
  }
  \and
  \inferrule{
    \DimEq{\mathcal{E}}{r}{r'}
  }{
    \Step{\mu}{
      \Cfg{\FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\mathcal{F}}{\pi}
    }
  }
  \and
  \inferrule{
    \DimApart{\mathcal{E}}{\mu}{\pi}{r}{r'}
    \\
    \DimApart{\mathcal{E}}{\mu}{\pi}{r_i}{r'_i}\ (\forall{}i<j)
    \\
    \DimEq{\mathcal{E}}{r_j}{r'_j}
  }{
    \Step{\mu}{
      \Cfg{
        \FCom{r}{r'}{M}{
          \overline{
            r_i=r'_i\hookrightarrow{}y.N_i
          }
        }
      }{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{N_j}{
        \perfectbrackets{
          \mathcal{E},y\hookrightarrow{}\mathcal{E}^+ (r')
        }
      }{\mathcal{F}}{\pi}
    }
  }
\end{mathparpagebreakable}

\subsection{Dependent function types}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\App{M}{N}}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}}{\mathcal{F}}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Lam{a}{M}}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\App{\Box}{N}}{\mathcal{E}'}{\mathcal{F}'}{[]}}{\pi}}
    }{
      \Cfg{M}{[\mathcal{E},a\hookrightarrow{\Clo{N}{\mathcal{E}'}{\mathcal{F}'}}]}{\mathcal{F}}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',\Meta{x}\hookrightarrow{}a.\Clo{B}{\mathcal{E}}{\mathcal{F}}
    }
  }{
    \Step{\mu}{
      \Cfg{
        \DFun{x}{A}{B}
      }{
        \mathcal{E}
      }{
        \mathcal{F}
      }{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
          }{\mathcal{E}'}{\mathcal{F}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \Lam{a}{
          \HCom{r}{r'}{\Meta{x}[a]}{\App{M}{a}}{
            \overline{\xi_i\hookrightarrow{}y.\App{N_i}{a}}
          }
        }
      }{\mathcal{E}''}{\mathcal{F}'}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}'' \triangleq%
    \perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow%
      x;b.\Clo{B}{
        \perfectbrackets{
          \mathcal{E},a\hookrightarrow%
          \Clo{
            \Coe{r'}{x}{x.\Meta{z}[x]}{b}
          }{
            \perfectbrackets{
              \mathcal{E'},
              \Meta{z}\hookrightarrow%
              x.\Clo{A}{\mathcal{E}}{\mathcal{F}}
            }
          }{
            \mathcal{F'}
          }
        }
      }{
        \mathcal{F}
      },
      \Meta{y}\hookrightarrow%
      x.\Clo{A}{\mathcal{E}}{\mathcal{F}}
    }
  }{
    \Step{\mu}{
      \Cfg{\DFun{a}{A}{B}}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{\mathcal{F}'}{[x]}}{\pi}}
    }{
      \Cfg{
        \Lam{a}{
          \Coe{r}{r'}{x.\Meta{x}[x;a]}{
            \App{M}{
              \Coe{r'}{r}{x.\Meta{y}[x]}{a}
            }
          }
        }
      }{
        \mathcal{E}''
      }{
        \mathcal{F}'
      }{
        \pi%
      }
    }
  }
\end{mathparpagebreakable}

\subsection{Dependent pair types}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Fst{M}}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\Fst{\Box}}{[]}{[]}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Snd{M}}{\mathcal{E}}{\mathcal{F}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\Snd{\Box}}{[]}{[]}{[]}}{\pi}}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Pair{M}{N}}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\Fst{\Box}}{[]}{[]}{[]}}{\pi}}
    }{
      \Cfg{M}{\mathcal{E}}{\mathcal{F}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Pair{M}{N}}{\mathcal{E}}{\mathcal{F}}{\Cons{\Frame{\Snd{\Box}}{[]}{[]}{[]}}{\pi}}
    }{
      \Cfg{N}{\mathcal{E}}{\mathcal{F}}{\pi}
    }
  }
  \and
  \inferrule{
    L_s\triangleq{
      \HCom{r}{s}{a}{\Fst{M}}{\overline{\xi_i\hookrightarrow{}y.\Fst{N_i}}}
    }
    \\
    R\triangleq{
      \Com{r}{r'}{z.\Meta{x}[z]}{\Snd{M}}{
        \overline{\xi_i\hookrightarrow{}y.\Snd{N_i}}
      }
    }
    \\\\
    \mathcal{E}''\triangleq{
      \perfectbrackets{
        \mathcal{E}',
        a\hookrightarrow{}\Clo{A}{\mathcal{E}}{\mathcal{F}}
      }
    }
    \\
    \mathcal{E}'''\triangleq{
      \perfectbrackets{
        \mathcal{E}'',
        \Meta{y}\hookrightarrow{}z.\Clo{
          B
        }{
          \perfectbrackets{
            \mathcal{E},
            a\hookrightarrow{}
            \Clo{L_z}{\mathcal{E}''}{\mathcal{F}}
          }
        }
      }
    }
  }{
    \Step{\mu}{
      \Cfg{\DPair{a}{A}{B}}{\mathcal{E}}{\mathcal{F}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi_i\hookrightarrow{}y.N_i}}
          }{\mathcal{E}'}{\mathcal{F}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \Pair{L_{r'}}{R}
      }{
        \mathcal{E}'''
      }{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}'' \triangleq%
    \perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{x.\Clo{A}{\mathcal{E}}},
      \Meta{y}\hookrightarrow{x.\Clo{B}{[\mathcal{E},a\hookrightarrow\Clo{\Coe{r}{x}{y.\Meta{x}[y]}{\Snd{M}}}{[\mathcal{E},\Meta{x}\hookrightarrow{x.\Clo{A}{\mathcal{E}}}]}]}}
    }
  }{
    \Step{\mu}{
      \Cfg{
        \DPair{a}{A}{B}
      }{
        \mathcal{E}
      }{
        \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
      }
    }{
      \Cfg{
        \Pair{
          \Coe{r}{r'}{x.\Meta{x}[x]}{\Fst{M}}
        }{
          \Coe{r}{r'}{x.\Meta{y}[x]}{\Snd{M}}
        }
      }{
        \mathcal{E}''
      }{
        \pi%
      }
    }
  }
\end{mathparpagebreakable}

\subsection{Path types}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\PApp{M}{r}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{
          \Frame{\PApp{\Box}{r}}{\mathcal{E}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\PAbs{x}{M}}{\mathcal{E}}{
        \Cons{
          \Frame{\PApp{\Box}{r}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{M}{
        \perfectbrackets{
          \mathcal{E},x\hookrightarrow\mathcal{E}' (r)
        }
      }{\pi}
    }
  }
  \and
  \inferrule{
    H\triangleq{
      \HCom{r}{r'}{\Meta{x}[x]}{\PApp{M}{x}}{
        \overline{
          x=\epsilon\hookrightarrow{}y.\Meta{y}_\epsilon%
        },
        \overline{
          \xi_i\hookrightarrow{}y.\PApp{N_i}{x}
        }
      }
    }
    \\
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{}x.\Clo{A}{\mathcal{E}},
      \overline{
        \Meta{y}_\epsilon\hookrightarrow{}.\Clo{P_\epsilon}{\mathcal{E}}%
      }
    }
  }{
    \Step{\mu}{
      \Cfg{\Path{x.A}{P_0}{P_1}}{
        \mathcal{E}
      }{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{
              \overline{
                \xi_i\hookrightarrow{}y.N_i
              }
            }
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \PAbs{x}{H}
      }{\mathcal{E}''}{\pi}
    }
  }
  \and
  \inferrule{
    \mathcal{E}''\triangleq\perfectbrackets{
      \mathcal{E}',
      \Meta{x}\hookrightarrow{}x.\Clo{A}{\mathcal{E}},
      \overline{
        \Meta{y}_\epsilon\hookrightarrow{}.\Clo{P_\epsilon}{\mathcal{E}}
      }
    }
  }{
    \Step{\mu}{
      \Cfg{
        \Path{x.A}{P_0}{P_1}
      }{
        \mathcal{E}
      }{
        \Cons{
          \Frame{
            \Coe{r}{r'}{\Box}{M}
          }{\mathcal{E}'}{[x]}
        }{\pi}
      }
    }{
      \Cfg{
        \PAbs{x}{
          \Com{r}{r'}{y.\Meta{x}[y]}{\PApp{M}{x}}{
            \overline{
              x=\epsilon\hookrightarrow{}y.{\Meta{y}_\epsilon}
            }
          }
        }
      }{\mathcal{E}''}{\pi}
    }
  }
\end{mathparpagebreakable}

\subsection{Natural numbers}
TODO

\subsection{Booleans}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\If{M}{T}{F}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{\Frame{\If{\Box}{T}{F}}{\mathcal{E}}{[]}}{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\True}{\mathcal{E}}{
        \Cons{\Frame{\If{\Box}{T}{F}}{\mathcal{E}'}{[]}}{\pi}
      }
    }{
      \Cfg{T}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\False}{\mathcal{E}}{
        \Cons{\Frame{\If{\Box}{T}{F}}{\mathcal{E}'}{[]}}{\pi}
      }
    }{
      \Cfg{F}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Bool}{\mathcal{E}}{
        \Cons{\Frame{\Coe{r}{r'}{\Box}{M}}{\mathcal{E}'}{[x]}}{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Bool}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
\end{mathparpagebreakable}

\subsection{Weak booleans}

\begin{mathparpagebreakable}
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\WIf{a.A}{M}{T}{F}}{\mathcal{E}}{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{\Frame{\WIf{a.A}{\Box}{T}{F}}{\mathcal{E}}{[]}}{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\True}{\mathcal{E}}{
        \Cons{\Frame{\WIf{a.A}{\Box}{T}{F}}{\mathcal{E}'}{[]}}{\pi}
      }
    }{
      \Cfg{T}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\False}{\mathcal{E}}{
        \Cons{\Frame{\WIf{a.A}{\Box}{T}{F}}{\mathcal{E}'}{[]}}{\pi}
      }
    }{
      \Cfg{F}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
    \DimApart{\mathcal{E}}{\mu}{\pi}{r}{r'}
    \\
    \DimApart{\mathcal{E}}{\mu}{\pi}{r_i}{r'_i}\ (\forall{}i)
    \\
    H\triangleq{
      \FCom{r}{z}{M}{
        \overline{
          r_i=r'_i\hookrightarrow{}y.N_i
        }
      }
    }
    \\
    \mathcal{E}''\triangleq{
      \perfectbrackets{
        \mathcal{E}',
        \Meta{x}\hookrightarrow{}z.\Clo{A}{
          \perfectbrackets{
            \mathcal{E}',
            a\hookrightarrow\Clo{H}{\mathcal{E}}
          }
        },
        \Meta{y}\hookrightarrow{}.\Clo{M}{\mathcal{E}},
        \overline{
          \Meta{z}_i\hookrightarrow{}y.\Clo{N_i}{\mathcal{E}}
        }
      }
    }
  }{
    \Cfg{
      \FCom{r}{r'}{M}{
        \overline{
          r_i=r'_i\hookrightarrow{}y.N_i
        }
      }
    }{
      \mathcal{E}'
    }{
      \Cons{
        \Frame{\WIf{a.A}{\Box}{T}{F}}{\mathcal{E}'}{[]}
      }{\pi}
    }
    \\\\
    \mathrel{\succ_\mu}
    \\\\
    \Cfg{
      \Com{\mathcal{E}^+ (r)}{\mathcal{E}^+ (r')}{z.\Meta{x}[z]}{
        \WIf{a.A}{\Meta{y}}{T}{F}
      }{
        \overline{
          \mathcal{E}^+ (r_i)=\mathcal{E}^+ (r'_i)
          \hookrightarrow{}
          y.\WIf{a.A}{\Meta{z}_i[y]}{T}{F}
        }
      }
    }{
      \mathcal{E}''
    }{\pi}
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\WBool}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}
      }{\mathcal{E'}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\WBool}{\mathcal{E}}{
        \Cons{
          \Frame{
            \Coe{r}{r'}{\Box}{M}
          }{\mathcal{E}'}{[x]}
        }{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
\end{mathparpagebreakable}

\subsection{Circle}

\begin{mathparpagebreakable}
  \inferrule{
    \DimEq{\mathcal{E}}{r}{\epsilon}
  }{
    \Step{\mu}{
      \Cfg{\Loop{r}}{\mathcal{E}}{\pi}
    }{
      \Cfg{\Base}{\mathcal{E}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{
        \CircRec{a.A}{M}{P}{x.L}
      }{
        \mathcal{E}
      }{\pi}
    }{
      \Cfg{M}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}}{[]}
        }{\pi}
      }
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Base}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{P}{\mathcal{E}'}{\pi}
    }
  }
  \and
  \inferrule{
    \DimEq{\mathcal{E}}{r}{w}
  }{
    \Step{\NonStable}{
      \Cfg{\Loop{r}}{\mathcal{E}}{
        \Cons{
          \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{L}{
        \perfectbrackets{
          \mathcal{E}',x\hookrightarrow{w}
        }
      }{\pi}
    }
  }
  \and
  \inferrule{
    \DimApart{\mathcal{E}}{\mu}{\pi}{r}{r'}
    \\
    \DimApart{\mathcal{E}}{\mu}{\pi}{r_i}{r'_i}\ (\forall{}i)
    \\
    H\triangleq{
      \FCom{r}{z}{M}{
        \overline{
          r_i=r'_i\hookrightarrow{}y.N_i
        }
      }
    }
    \\
    \mathcal{E}''\triangleq{
      \perfectbrackets{
        \mathcal{E}',
        \Meta{x}\hookrightarrow{}z.\Clo{A}{
          \perfectbrackets{
            \mathcal{E}',
            a\hookrightarrow\Clo{H}{\mathcal{E}}
          }
        },
        \Meta{y}\hookrightarrow{}.\Clo{M}{\mathcal{E}},
        \overline{
          \Meta{z}_i\hookrightarrow{}y.\Clo{N_i}{\mathcal{E}}
        }
      }
    }
  }{
    \Cfg{
      \FCom{r}{r'}{M}{
        \overline{
          r_i=r'_i\hookrightarrow{}y.N_i
        }
      }
    }{
      \mathcal{E}'
    }{
      \Cons{
        \Frame{\CircRec{a.A}{\Box}{P}{x.L}}{\mathcal{E}'}{[]}
      }{\pi}
    }
    \\\\
    \mathrel{\succ_\mu}
    \\\\
    \Cfg{
      \Com{\mathcal{E}^+ (r)}{\mathcal{E}^+ (r')}{z.\Meta{x}[z]}{
        \CircRec{a.A}{\Meta{y}}{P}{x.L}
      }{
        \overline{
          \mathcal{E}^+ (r_i)=\mathcal{E}^+ (r'_i)
          \hookrightarrow{}
          y.\CircRec{a.A}{\Meta{z}_i[y]}{P}{x.L}
        }
      }
    }{
      \mathcal{E}''
    }{\pi}
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Circ}{\mathcal{E}}{
        \Cons{
          \Frame{
            \HCom{r}{r'}{\Box}{M}{\overline{\xi\hookrightarrow{}y.N}}
          }{\mathcal{E}'}{[]}
        }{\pi}
      }
    }{
      \Cfg{
        \FCom{r}{r'}{M}{\overline{\xi\hookrightarrow{}y.N}}
      }{\mathcal{E'}}{\pi}
    }
  }
  \and
  \inferrule{
  }{
    \Step{\mu}{
      \Cfg{\Circ}{\mathcal{E}}{
        \Cons{
          \Frame{
            \Coe{r}{r'}{\Box}{M}
          }{\mathcal{E}'}{[x]}
        }{\pi}
      }
    }{
      \Cfg{M}{\mathcal{E}'}{\pi}
    }
  }
\end{mathparpagebreakable}


\paragraph{Unloading the machine}

We can unload the machine at any time; this is useful if we are
computing an open term and hit a variable.

\begin{mathpar}
  \inferrule{
  }{
    \Cfg{M}{\mathcal{E}}{\cdot}\Longrightarrow{M[\mathcal{E}]}
  }
  \and
  \inferrule{
    \Cfg{K[\Psi.M[\mathcal{E}]]}{\mathcal{E}'}{\pi}\Longrightarrow{N}
  }{
    \Cfg{M}{\mathcal{E}}{\Cons{\Frame{K[\Box]}{\mathcal{E}'}{\Psi}}{\pi}}\Longrightarrow{N}
  }
\end{mathpar}

But using Favonia's Thought, we can come up with something more
efficient. This na\"ive version is rather appalling.


\end{document}
